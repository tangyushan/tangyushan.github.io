<!DOCTYPE html>

<html>
    <head>
        <title>学生成绩查询</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="shortcut icon" type="image/ico" href="favicon.ico" />

        <link rel="stylesheet" href="../css/style.css">

        <script type="text/javascript" src="../js/xlsx.full.min.js"></script>
        
        <style type="text/css">
            img {
                width: 65px;
                height: 50px;
                margin: auto 430px;
                float: right;
            }
            
            div {
                width: 250px;
                margin: auto auto;
            }
            
            select {
                width: 100%;
                padding: auto auto;
                margin: 8px 0;
                
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
                
                height: 2em;
            }
            
            table {
                margin: 2em auto;
            }
            
            table caption {
                font-size: 120%;
            }
            
            table tr:nth-child(n+3) td {
                text-align: right;
            }
            
            table tr:nth-child(n+3) td:last-child {
                color: #ccc;
            }
            
            table th, table td {
                width: 70px;
            }
            
            table tfoot {
                background: #B5D7D8;
            }
            
            table tfoot td {
                text-align: right;
            }
        </style>
        
        <script type="text/javascript">
            function init() {
                checkAuthority();
                
                //retrieveData();
            }
            
            function checkAuthority() {
                if (sessionStorage.schoolId === undefined) {
                    window.location.href = "login.html";
                }
            }
            
            function query(sender) {
                if (sender.value !== "0") {
                    var url = "../data/19-20下学期" + sender.value + "月月考成绩分析表.xlsx";
                    retrieveData(url);
                    document.getElementsByTagName("table")[0].caption.textContent = "2019-2020学年度下学期" + sender.value + "月月考成绩";
                }
            }
            
            function retrieveData(url) {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);
                xhr.responseType = "arraybuffer";
                
                xhr.onload = function(e) {
                    var data = new Uint8Array(xhr.response);
                    var workbook = XLSX.read(data, {type: "array"});
                    onOpenWorkBook(workbook);
                };
                
                xhr.send();
                document.getElementsByTagName("img")[0].hidden = "";
            }
            
            function onOpenWorkBook(wb) {
                document.getElementsByTagName("img")[0].hidden = "hidden";
                var schoolId = parseInt(sessionStorage.schoolId);
                
                var sheet = wb.Sheets["总表"];
                
                var record = {
                    学号: "",
                    姓名: "",
                    
                    语文: {
                        分数: 0,
                        班级排名: 0,
                        年级排名: 0
                    },
                    
                    数学: {
                        分数: 0,
                        班级排名: 0,
                        年级排名: 0
                    },
                    
                    英语: {
                        分数: 0,
                        班级排名: 0,
                        年级排名: 0
                    },
                    
                    政治: {
                        分数: 0,
                        班级排名: 0,
                        年级排名: 0
                    },
                    
                    历史: {
                        分数: 0,
                        班级排名: 0,
                        年级排名: 0
                    },
                    
                    地理: {
                        分数: 0,
                        班级排名: 0,
                        年级排名: 0
                    },
                    
                    生物: {
                        分数: 0,
                        班级排名: 0,
                        年级排名: 0
                    },
                    
                    总分: {
                        分数: 0,
                        班级排名: 0,
                        年级排名: 0
                    }
                };
                
                for (var i = 2; i <= 314; i++) {
                    var id = sheet["A"+i].v;
                    
                    if (schoolId === id) {
                        record.学号 = sheet["A"+i].v;
                        record.姓名 = sheet["B"+i].v;
                        record.语文.分数 = sheet["C"+i].v;
                        record.数学.分数 = sheet["D"+i].v;
                        record.英语.分数 = sheet["E"+i].v;
                        record.政治.分数 = sheet["F"+i].v;
                        record.历史.分数 = sheet["G"+i].v;
                        record.地理.分数 = sheet["H"+i].v;
                        record.生物.分数 = sheet["I"+i].v;
                        record.总分.分数 = sheet["J"+i].v;
                        record.总分.年级排名 = sheet["K"+i].v;
                        record.总分.班级排名 = sheet["L"+i].v;
                        
                        record.语文.年级排名 = sheet["M"+i].v;
                        record.数学.年级排名 = sheet["N"+i].v;
                        record.英语.年级排名 = sheet["O"+i].v;
                        record.政治.年级排名 = sheet["P"+i].v;
                        record.历史.年级排名 = sheet["Q"+i].v;
                        record.地理.年级排名 = sheet["R"+i].v;
                        record.生物.年级排名 = sheet["S"+i].v;

                        break;
                    }
                }
                
                var table = document.getElementsByTagName("table")[0];
                var tbody = table.tBodies[0];
                
                tbody.rows[0].cells[1].textContent = record.学号;
                tbody.rows[1].cells[1].textContent = record.姓名;
                
                tbody.rows[3].cells[1].textContent = record.语文.分数;
                tbody.rows[3].cells[2].textContent = record.语文.年级排名;
                tbody.rows[3].cells[3].textContent = "N/A";
                
                tbody.rows[4].cells[1].textContent = record.数学.分数;
                tbody.rows[4].cells[2].textContent = record.数学.年级排名;
                tbody.rows[4].cells[3].textContent = "N/A";
                
                tbody.rows[5].cells[1].textContent = record.英语.分数;
                tbody.rows[5].cells[2].textContent = record.英语.年级排名;
                tbody.rows[5].cells[3].textContent = "N/A";
                
                tbody.rows[6].cells[1].textContent = record.政治.分数;
                tbody.rows[6].cells[2].textContent = record.政治.年级排名;
                tbody.rows[6].cells[3].textContent = "N/A";
                
                tbody.rows[7].cells[1].textContent = record.历史.分数;
                tbody.rows[7].cells[2].textContent = record.历史.年级排名;
                tbody.rows[7].cells[3].textContent = "N/A";
                
                tbody.rows[8].cells[1].textContent = record.地理.分数;
                tbody.rows[8].cells[2].textContent = record.地理.年级排名;
                tbody.rows[8].cells[3].textContent = "N/A";
                
                tbody.rows[9].cells[1].textContent = record.生物.分数;
                tbody.rows[9].cells[2].textContent = record.生物.年级排名;
                tbody.rows[9].cells[3].textContent = "N/A";
                
                var tfoot = table.tFoot;
                tfoot.rows[0].cells[1].textContent = record.总分.分数;
                tfoot.rows[0].cells[2].textContent = record.总分.年级排名;
                tfoot.rows[0].cells[3].textContent = record.总分.班级排名;
            }
            
            window.addEventListener("DOMContentLoaded", init);
        </script>
    </head>
    <body>
        <div>
            <form>
                <select id="month" onchange="query(this)">
                    <option value="0">请选择时间：</option>
                    <option value="5">5月月考成绩</option>
                    <option value="7">7月月考成绩</option>
                </select>
            </form>
        </div>
        <img src="../imgs/loading.gif" alt="loading" hidden="hidden" />
        <table>
            <caption>月考成绩</caption>
            <tbody>
                <tr><th>学号</th><td colspan="3"></td></tr>
                <tr><th>姓名</th><td colspan="3"></td></tr>
                <tr><th>科目</th><th>分数</th><th>年级排名</th><th>班级排名</th></tr>
                <tr><th>语文</th><td></td><td></td><td></td></tr>
                <tr><th>数学</th><td></td><td></td><td></td></tr>
                <tr><th>英语</th><td></td><td></td><td></td></tr>
                <tr><th>政治</th><td></td><td></td><td></td></tr>
                <tr><th>历史</th><td></td><td></td><td></td></tr>
                <tr><th>地理</th><td></td><td></td><td></td></tr>
                <tr><th>生物</th><td></td><td></td><td></td></tr>
            </tbody>
            <tfoot>
                <tr><th>总分</th><td></td><td></td><td></td></tr>
            </tfoot>
        </table>
        
        
    </body>
</html>
